version: 2
jobs:
  build_and_deploy:
    working_directory: /home/presto/presto
    environment:
      - PLAZMA_ENV: circle_test
      - RUN_SUBTREE_TEST: true
      - MAVEN_OPTS: -Xmx4g -Xms4g
      - _JAVA_OPTIONS: -Xmx4g -Xms4g -XX:ReservedCodeCacheSize=300M -XX:MaxPermSize=300M -XX:InitiatingHeapOccupancyPercent=30
      - RUBY_VERSION: 2.4.1
      - MAVEN_USER_HOME: /home/presto/.m2
      - JAVA_HOME: /home/presto/.java/jdk1.8.0_181
      #- PATH: /home/presto/.java/jdk1.8.0_131/bin::$PATH
    docker:
      - image: 523683666290.dkr.ecr.us-east-1.amazonaws.com/td-build:latest
        aws_auth:
          aws_access_key_id: $AWS_ACCESS_KEY_ID
          aws_secret_access_key: $AWS_SECRET_ACCESS_KEY
    resource_class: xlarge
    steps:
      - checkout
      - run:
          name: Setup non-priviledged user (presto)
          command: |
            apt-get update
            apt-get install -y sudo
            useradd -m presto
            chown -R presto /home/presto/presto
            mkdir /home/presto/.m2
            chown -R presto /home/presto/.m2

      - restore_cache:
          key: presto-{{ checksum "pom.xml" }}

      - run:
          name: Install Prerequisites
          command: |
            # install 8u131
            mkdir -p $(dirname $JAVA_HOME)
            test -d $JAVA_HOME || curl -L -C - -b "oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u181-b13/96a7b8442fe848ef90c96a2fad6ed6d1/jdk-8u181-linux-x64.tar.gz | tar zxvf - -C $(dirname $JAVA_HOME)

      - run:
          name: Build presto
          command: |
            # Assign a unique version number to the modules
            rake update-pom
            # Run mvn test-compile here to cache the compile-time dependencies
            rake compile

      - save_cache:
          paths:
            - /home/presto/.m2
            - /root/.m2
          key: presto-{{ checksum "pom.xml" }}

      - run:
          name: deploy
          command: |
            rake deploy

workflows:
  version: 2
  build_and_integration:
    jobs:
      - build_and_deploy:
          filters:
            tags:
              only: /.*/


